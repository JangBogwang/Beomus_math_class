<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Stage 4 - 구구단 게임</title>
    <link rel="icon" href="../asset/stage/stage4.png">
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@700&display=swap" rel="stylesheet">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            font-family: 'Gaegu', cursive;
        }
        .game-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 480px;
            margin: 0 auto;
            background-image: url('../asset/stage/stage4.png');
            background-size: cover;
            background-position: center;
            overflow: hidden;
        }
        .loading-screen, .countdown-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 2em;
            z-index: 10;
        }
        .countdown {
            font-size: 5em;
            animation: countdown-animation 1s infinite;
        }
        @keyframes countdown-animation {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }
        .game-scene {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Space out elements */
            align-items: center;
            padding: 2vh 0;
        }
        .top-ui {
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 2vw;
        }
        .timer, .score {
            font-size: clamp(1.5em, 4vw, 2em);
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 5px 15px;
            border-radius: 10px;
        }
        .character-area {
            text-align: center;
        }
        .character {
            width: 30vw;
            max-width: 120px;
            height: 45vw;
            max-height: 180px;
            object-fit: contain;
        }
        .speech-bubble {
            background: white;
            border-radius: 20px;
            padding: 1vh 4vw;
            width: 80%;
            max-width: 300px;
            text-align: center;
            font-size: clamp(1.2em, 4vw, 1.5em);
            color: #333;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
            margin-top: -10px;
        }
        .speech-bubble::before {
            content: '';
            position: absolute;
            top: -19px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 20px 20px;
            border-style: solid;
            border-color: transparent transparent white;
        }
        .decree-display {
            background: rgba(0, 0, 0, 0.7);
            color: #ffd700;
            padding: 10px 20px;
            border-radius: 15px;
            font-size: clamp(1.2em, 4vw, 1.5em);
            border: 2px solid #ffd700;
            box-shadow: 0 0 15px #ffd700;
            text-align: center;
        }
        .answer-choices {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2vw;
            padding: 0 4vw;
        }
        .choice-card {
            background: url('../asset/action/crown.svg') no-repeat center center;
            background-size: contain;
            border-radius: 15px;
            padding: 15px;
            font-size: clamp(1.5em, 5vw, 2em);
            text-align: center;
            color: #333;
            cursor: pointer;
            transition: all 0.1s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 12vh;
            position: relative;
        }
        .choice-card.clicked {
            background-color: rgba(255, 215, 0, 0.5);
        }
        .choice-card span {
            position: relative;
            z-index: 1;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
        }
        .end-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background-color: rgba(0, 0, 0, 0.8); color: white; text-align: center; z-index: 20;
        }
        .end-screen h1 { font-size: 3em; margin-bottom: 10px; }
        .end-screen h2 { font-size: 2em; margin-bottom: 20px; }
        .end-screen-btn-group { display: flex; gap: 20px; }
        .end-screen-btn {
            display: inline-block; margin-top: 20px; padding: 10px 20px;
            background-color: #ff89c0; color: white; text-decoration: none;
            border-radius: 10px; font-size: 1.2em;
        }
        .shake { animation: shake-horizontal 0.5s; }
        @keyframes shake-horizontal {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="loading-screen"><p>게임을 불러오는 중입니다.</p></div>
        <div class="countdown-screen" style="display: none;"><p class="countdown"></p></div>
        <div class="game-scene" style="display: none;">
            <div class="top-ui">
                <div class="timer">Time: 60</div>
                <div class="score">Score: 0</div>
            </div>
            <div class="character-area">
                <img src="../asset/character/idol.png" alt="Prince Character" class="character">
                <div class="speech-bubble"><p id="question"></p></div>
            </div>
            <div class="decree-display" id="decree"></div>
            <div class="answer-choices">
                <div class="choice-card"><span></span></div>
                <div class="choice-card"><span></span></div>
                <div class="choice-card"><span></span></div>
                <div class="choice-card"><span></span></div>
            </div>
        </div>
    </div>

    <audio id="bgm" loop><source src="../asset/bgm/stage3.mp3" type="audio/mpeg"></audio>

    <script>
        const gameScene = document.querySelector('.game-scene');
        const bgm = document.getElementById('bgm');
        const questionEl = document.getElementById('question');
        const choiceCards = document.querySelectorAll('.choice-card');
        const timerEl = document.querySelector('.timer');
        const scoreEl = document.querySelector('.score');
        const decreeEl = document.getElementById('decree');

        let score = 0, timeLeft = 60, timerInterval, currentAnswer, currentDecree;
        let clickCount = 0, lastClickedCard = null, clickTimer = null;
        let avoidClickCorrect = false, avoidClickedCount = 0;

        const DECREES = {
            SINGLE_CLICK: "정답을 한 번만 클릭하라!",
            DOUBLE_CLICK: "정답을 두 번 클릭하라!",
            AVOID_ANSWER: "정답을 제외한 나머지를 클릭하라!"
        };

        function issueDecree() {
            const decreeKeys = Object.keys(DECREES);
            const randomKey = decreeKeys[Math.floor(Math.random() * decreeKeys.length)];
            currentDecree = randomKey;
            decreeEl.textContent = DECREES[randomKey];
        }

        function generateQuestion() {
            // Reset states
            clickCount = 0;
            lastClickedCard = null;
            avoidClickedCount = 0;
            avoidClickCorrect = false;
            choiceCards.forEach(c => c.classList.remove('clicked'));

            if (Math.random() < 0.5) { // Issue a new decree sometimes
                issueDecree();
            }

            const a = Math.floor(Math.random() * 8) + 2;
            const b = Math.floor(Math.random() * 9) + 1;
            currentAnswer = a * b;
            questionEl.textContent = `${a} × ${b} = ?`;

            const choices = generateChoices(currentAnswer);
            choiceCards.forEach((card, index) => {
                card.querySelector('span').textContent = choices[index];
                card.dataset.value = choices[index];
                card.onclick = () => handleCardClick(card);
            });
        }

        function handleCardClick(card) {
            const selectedValue = parseInt(card.dataset.value);

            switch (currentDecree) {
                case 'SINGLE_CLICK':
                    if (selectedValue === currentAnswer) succeed(); else fail(card);
                    break;
                case 'DOUBLE_CLICK':
                    if (selectedValue !== currentAnswer) {
                        fail(card);
                        return;
                    }
                    if (lastClickedCard !== card) {
                        clearTimeout(clickTimer);
                        clickCount = 1;
                        lastClickedCard = card;
                        clickTimer = setTimeout(() => { clickCount = 0; lastClickedCard = null; }, 400);
                    } else {
                        clickCount++;
                    }
                    if (clickCount === 2) {
                        succeed();
                    }
                    break;
                case 'AVOID_ANSWER':
                    if (selectedValue === currentAnswer) {
                        fail(card);
                    } else {
                        if (!card.classList.contains('clicked')) {
                            card.classList.add('clicked');
                            avoidClickedCount++;
                        }
                        if (avoidClickedCount === 3) {
                            succeed();
                        }
                    }
                    break;
            }
        }

        function succeed() {
            score++;
            scoreEl.textContent = `Score: ${score}`;
            setTimeout(generateQuestion, 300);
        }

        function fail(card) {
            card.classList.add('shake');
            setTimeout(() => card.classList.remove('shake'), 500);
            if (score > 0) score--;
            scoreEl.textContent = `Score: ${score}`;
        }

        // --- Boilerplate functions (startGame, startTimer, etc.) ---
        function generateChoices(correctAnswer) {
            const choices = new Set([correctAnswer]);
            while (choices.size < 4) {
                const wrongAnswer = correctAnswer + Math.floor(Math.random() * 10) - 5;
                if (wrongAnswer !== correctAnswer && wrongAnswer > 0) choices.add(wrongAnswer);
            }
            return Array.from(choices).sort(() => Math.random() - 0.5);
        }

        function endGame() {
            bgm.pause();
            clearInterval(timerInterval);
            let endMessage = `<h1>게임 종료!</h1><h2>최종 점수: ${score}</h2>`;
            if (score >= 10) endMessage += '<h2>축하합니다! 통과!</h2>';
            else endMessage += '<h2>아쉽지만... 다시 도전해보세요!</h2>';
            
            const endScreen = document.createElement('div');
            endScreen.className = 'end-screen';
            endScreen.innerHTML = `
                <div>
                    ${endMessage}
                    <div class="end-screen-btn-group">
                        <a href="stage3.html" class="end-screen-btn">다시하기</a>
                        <a href="../select_stage.html" class="end-screen-btn">스테이지 선택으로</a>
                    </div>
                </div>
            `;
            document.querySelector('.game-container').appendChild(endScreen);
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = `Time: ${timeLeft}`;
                if (timeLeft <= 0) endGame();
            }, 1000);
        }

        function startGame() {
            document.querySelector('.loading-screen').style.display = 'none';
            document.querySelector('.countdown-screen').style.display = 'flex';
            let count = 3;
            document.querySelector('.countdown').textContent = count;
            const countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    document.querySelector('.countdown').textContent = count;
                } else {
                    clearInterval(countdownInterval);
                    document.querySelector('.countdown-screen').style.display = 'none';
                    gameScene.style.display = 'flex';
                    bgm.play().catch(()=>{});
                    startTimer();
                    issueDecree(); // First decree
                    generateQuestion();
                }
            }, 1000);
        }
        
        // Simplified loader for brevity
        window.onload = startGame;

    </script>
</body>
</html>