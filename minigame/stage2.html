<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Stage 2 - Íµ¨Íµ¨Îã® Í≤åÏûÑ</title>
    <link rel="icon" href="../asset/stage/stage2.png">
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@700&display=swap" rel="stylesheet">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            font-family: 'Gaegu', cursive;
        }
        .game-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 480px; /* Mobile-like width */
            margin: 0 auto;
            background-image: url('../asset/stage/stage2.png');
            background-size: cover;
            background-position: center;
            overflow: hidden;
        }
        .loading-screen, .countdown-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 2em;
            z-index: 10;
        }
        .countdown {
            font-size: 5em;
            animation: countdown-animation 1s infinite;
        }
        @keyframes countdown-animation {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }
        .game-scene {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-around; /* Distribute space */
            align-items: center;
            padding: 2vh 0;
        }
        .character {
            width: 30vw;
            max-width: 150px;
            height: 45vw;
            max-height: 225px;
            object-fit: contain;
            margin-top: 5vh; /* Add some margin */
        }
        .speech-bubble {
            background: white;
            border-radius: 20px;
            padding: 2vh 4vw;
            width: 80%;
            max-width: 300px;
            text-align: center;
            font-size: clamp(1.5em, 5vw, 2em);
            color: #333;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative; /* Use relative for the arrow */
            margin-top: -20px; /* Pull it up a bit */
        }
        .speech-bubble::before {
            content: '';
            position: absolute;
            top: -19px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 20px 20px;
            border-style: solid;
            border-color: transparent transparent white;
        }
        #dialogue {
            font-size: 0.7em;
            color: #666;
            margin-top: 10px;
        }
        .answer-choices {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2vw;
            padding: 0 4vw;
            margin-bottom: 5vh; /* Add some margin */
            transition: transform 0.5s ease-in-out; /* For shuffling */
        }
        .choice-card {
            background: url('../asset/action/beach-ball.svg') no-repeat center center;
            background-size: contain;
            border-radius: 15px;
            padding: 15px;
            font-size: clamp(1.5em, 5vw, 2em);
            text-align: center;
            color: #333;
            cursor: pointer;
            transition: transform 0.1s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 15vh;
            position: relative;
        }
        .choice-card span {
            position: relative;
            z-index: 1;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
        }
        .timer, .score {
            position: absolute;
            top: 2vh;
            font-size: clamp(1.5em, 4vw, 2em);
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 5px 15px;
            border-radius: 10px;
        }
        .timer { left: 2vw; }
        .score { right: 2vw; }

                .end-screen {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    background-color: rgba(0, 0, 0, 0.8);
                    color: white;
                    text-align: center;
                    z-index: 20;
                }
                .end-screen h1 {
                    font-size: 3em;
                    margin-bottom: 10px;
                }
                .end-screen h2 {
                    font-size: 2em;
                    margin-bottom: 20px;
                }
                .end-screen-btn-group {
                    display: flex;
                    gap: 20px;
                }
                .end-screen-btn {
                    display: inline-block;
                    margin-top: 20px;
                    padding: 10px 20px;
                    background-color: #ff89c0;
                    color: white;
                    text-decoration: none;
                    border-radius: 10px;
                    font-size: 1.2em;
                }
        
                /* ÌÅ¥Î¶≠¬∑Ï†ïÎãµ Ìö®Í≥º Ïú†ÏßÄ */
                .correct-flash { animation: flash-correct 0.5s; }
                @keyframes flash-correct {
                0%, 100% { background-color: #8eff8e; }
                50% { background-color: white; }
                }
                .shake { animation: shake-horizontal 0.5s; }
                @keyframes shake-horizontal {
                0%, 100% { transform: translateX(0); }
                10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
                20%, 40%, 60%, 80% { transform: translateX(10px); }
                }
        
                /* ÎπÑÏπòÎ≥º ÌäÄÏñ¥ ÎÇòÍ∞ÄÍ∏∞ */
                .ball-fly {
                position: fixed;
                width: 56px;
                height: 56px;
                pointer-events: none;
                z-index: 9999;
                animation: ballBounceOut 900ms ease-out forwards;
                filter: drop-shadow(0 6px 12px rgba(0,0,0,.25));
                }
        
                @keyframes ballBounceOut {
                0%   { transform: translate(0, 0) scale(0.9); opacity: 1; }
                25%  { transform: translate(0, -24px) scale(1.05); }
                40%  { transform: translate(0, 0) scale(1.0); }
                60%  { transform: translate(80px, -80px) scale(1.05); }
                100% { transform: translate(240px, -200px) scale(0.9); opacity: 0; }
                }
            </style>
        </head>
        <body>
            <div class="game-container">
                <div class="loading-screen">
                    <p>Í≤åÏûÑÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§.</p>
                </div>
                <div class="countdown-screen" style="display: none;">
                    <p class="countdown"></p>
                </div>
                <div class="game-scene" style="display: none;">
                    <div class="timer">Time: 60</div>
                    <div class="score">Score: 0</div>
                    <img src="../asset/character/bikini.png" alt="Normal Character" class="character">
                    <div class="speech-bubble">
                        <p id="question"></p>
                        <p id="dialogue"></p>
                    </div>
                    <div class="answer-choices">
                        <div class="choice-card"><span></span></div>
                        <div class="choice-card"><span></span></div>
                        <div class="choice-card"><span></span></div>
                        <div class="choice-card"><span></span></div>
                    </div>
                </div>
            </div>
        
            <audio id="bgm" loop>
                <source src="../asset/bgm/stage2.mp3" type="audio/mpeg">
            </audio>
        
            <script>
                const loadingScreen = document.querySelector('.loading-screen');
                const countdownScreen = document.querySelector('.countdown-screen');
                const countdownEl = document.querySelector('.countdown');
                const gameScene = document.querySelector('.game-scene');
                const bgm = document.getElementById('bgm');
                const questionEl = document.getElementById('question');
                const dialogueEl = document.getElementById('dialogue');
                const answerChoices = document.querySelector('.answer-choices');
                const choiceCards = document.querySelectorAll('.choice-card'); // Í≥†Ï†ï Ï∞∏Ï°∞(Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî©Ïö©)
                const timerEl = document.querySelector('.timer');
                const scoreEl = document.querySelector('.score');
        
                let score = 0;
                let timeLeft = 60;
                let timerInterval;
                let dialogueInterval;
                let shuffleInterval;
                let currentAnswer;
        
                // Ï†ïÎãµ Ïï†ÎãàÎ©îÏù¥ÏÖò Ï§ëÏóî ÏÖîÌîå Ïû†Í∏à
                let shuffleLocked = false;
        
                const dialogues = [
                    "Ïó¨Î¶ÑÏù¥Îã§!",
                    "Î™®ÎûòÏÑ± ÎßåÎì§Ïûê!",
                    "Î¨ºÎÜÄÏù¥ ÌïòÎü¨ Í∞àÎûò?",
                    "ÎßõÏûàÎäî ÏàòÎ∞ï Î®πÏûê.",
                    "Îã§ÏùåÏóê Îòê ÎÜÄÏûê."
                ];
        
                function preloadResources() {
                    const resources = [
                    '../asset/stage/stage2.png',
                    '../asset/character/bikini.png',
                    '../asset/bgm/stage2.mp3',
                    '../asset/action/beach-ball.svg'
                    ];
                    let loadedCount = 0;
                    const done = () => { loadedCount++; if (loadedCount === resources.length) startGame(); };
        
                    resources.forEach(res => {
                    if (res.endsWith('.png') || res.endsWith('.svg')) {
                        const img = new Image();
                        img.onload = done; img.onerror = done;
                        img.src = res;
                    } else if (res.endsWith('.mp3')) {
                        const audio = new Audio();
                        // canplaythroughÍ∞Ä Î∏åÎùºÏö∞Ï†ÄÎßàÎã§ Ïó¨Îü¨ Î≤à Ïò¨ Ïàò ÏûàÏñ¥ Ìïú Î≤àÎßå Ïπ¥Ïö¥Ìä∏
                        const once = () => { audio.removeEventListener('canplaythrough', once); done(); };
                        audio.addEventListener('canplaythrough', once, { once:true });
                        audio.src = res;
                    }
                    });
                }
        
                function startGame() {
                    loadingScreen.style.display = 'none';
                    countdownScreen.style.display = 'flex';
                    let count = 3;
                    countdownEl.textContent = count;
                    const countdownInterval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        countdownEl.textContent = count;
                    } else {
                        clearInterval(countdownInterval);
                        countdownScreen.style.display = 'none';
                        gameScene.style.display = 'flex';
                        bgm.play().catch(()=>{});
                        startTimer();
                        startDialogue();
                        startShuffle();
                        generateQuestion();
                    }
                    }, 1000);
                }
        
                function startTimer() {
                    clearInterval(timerInterval);
                    timerInterval = setInterval(() => {
                    timeLeft--;
                    timerEl.textContent = `Time: ${timeLeft}`;
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        clearInterval(dialogueInterval);
                        clearInterval(shuffleInterval);
                        endGame();
                    }
                    }, 1000);
                }
        
                function startDialogue() {
                    clearInterval(dialogueInterval);
                    let dialogueIndex = 0;
                    dialogueEl.textContent = dialogues[dialogueIndex];
                    dialogueInterval = setInterval(() => {
                    dialogueIndex = (dialogueIndex + 1) % dialogues.length;
                    dialogueEl.textContent = dialogues[dialogueIndex];
                    }, 10000);
                }
        
                // ‚úÖ ÏÖîÌîå ÏïàÏ†ïÌôî: Î∂ÄÎ™®Ïùò ÌòÑÏû¨ ÏûêÏãù ÏàúÏÑúÎ•º Í∏∞Ï§ÄÏúºÎ°ú Îß§Î≤à ÏÉàÎ°ú ÏÑûÍ≥† Ïû¨Î∞∞Ïπò
                function startShuffle() {
                    clearInterval(shuffleInterval);
                    shuffleInterval = setInterval(() => {
                    if (shuffleLocked) return; // Ï†ïÎãµ Ï≤òÎ¶¨ Ï§ëÏóî ÏÑûÏßÄ ÏïäÏùå
                    const cards = Array.from(answerChoices.children); // ÌòÑÏû¨ DOM ÏàúÏÑú
                    for (let i = cards.length - 1; i > 0; i--) {      // Fisher‚ÄìYates
                        const j = Math.floor(Math.random() * (i + 1));
                        [cards[i], cards[j]] = [cards[j], cards[i]];
                    }
                    cards.forEach(card => answerChoices.appendChild(card)); // Ïû¨Î∞∞Ïπò
                    }, 3000);
                }
        
                function generateQuestion() {
                    shuffleLocked = false; // ÏÉà Î¨∏Ï†úÏóêÏÑúÎäî ÏÖîÌîå ÌóàÏö©
                    const a = Math.floor(Math.random() * 4) + 6; // 6~9
                    const b = Math.floor(Math.random() * 9) + 1; // 1~9
                    currentAnswer = a * b;
                    questionEl.textContent = `${a} √ó ${b} = ?`;
        
                    const choices = generateChoices(currentAnswer);
                    choiceCards.forEach((card, index) => {
                    card.classList.remove('correct-flash','shake');
                    card.querySelector('span').textContent = choices[index];
                    card.onclick = () => checkAnswer(card, choices[index]);
                    });
                }
        
                function generateChoices(correctAnswer) {
                    const choices = new Set([correctAnswer]);
                    while (choices.size < 4) {
                    const delta = Math.floor(Math.random() * 11) - 5; // -5~+5
                    const wrongAnswer = correctAnswer + delta || correctAnswer + 7; // 0 Î∞©ÏßÄ
                    if (wrongAnswer > 0) choices.add(wrongAnswer);
                    }
                    return Array.from(choices).sort(() => Math.random() - 0.5);
                }
        
                // üéâ Ï†ïÎãµ Ïãú ÎπÑÏπòÎ≥º ÌäÄÏñ¥ ÎÇòÍ∞ÄÍ∏∞
                function spawnBounceBall(fromCard) {
                    const rect = fromCard.getBoundingClientRect();
                    const img = document.createElement('img');
                    img.src = '../asset/action/beach-ball.svg';
                    img.className = 'ball-fly';
                    img.style.left = (rect.left + rect.width/2 - 28) + 'px';
                    img.style.top  = (rect.top + rect.height/2 - 28) + 'px';
                    document.body.appendChild(img);
                    img.addEventListener('animationend', () => img.remove());
                }
        
                function checkAnswer(card, selectedAnswer) {
                    card.classList.remove('correct-flash', 'shake');
                    if (selectedAnswer === currentAnswer) {
                    shuffleLocked = true;                 // ‚õî Ï†ïÎãµ Ï≤òÎ¶¨ Ï§ë ÏÖîÌîå Ïû†Í∏à
                    score++;
                    scoreEl.textContent = `Score: ${score}`;
                    card.classList.add('correct-flash');
                    spawnBounceBall(card);                // üèê ÌÜµÌÜµ ÌäÄÎ©∞ ÎÇ†ÏïÑÍ∞ÄÍ∏∞
                    setTimeout(generateQuestion, 300);    // Îã§Ïùå Î¨∏Ï†ú
                    } else {
                    card.classList.add('shake');
                    }
                }
        
                function endGame() {
                    bgm.pause();
                    let endMessage = `<h1>Í≤åÏûÑ Ï¢ÖÎ£å!</h1><h2>ÏµúÏ¢Ö Ï†êÏàò: ${score}</h2>`;
                    if (score >= 10) {
                        endMessage += '<h2>Ï∂ïÌïòÌï©ÎãàÎã§! ÌÜµÍ≥º!</h2>';
                    } else {
                        endMessage += '<h2>ÏïÑÏâΩÏßÄÎßå... Îã§Ïãú ÎèÑÏ†ÑÌï¥Î≥¥ÏÑ∏Ïöî!</h2>';
                    }
                    const endScreen = document.createElement('div');
                    endScreen.className = 'end-screen';
                    endScreen.innerHTML = `
                        <div>
                            ${endMessage}
                            <div class="end-screen-btn-group">
                                <a href="stage2.html" class="end-screen-btn">Îã§ÏãúÌïòÍ∏∞</a>
                                <a href="../select_stage.html" class="end-screen-btn">Ïä§ÌÖåÏù¥ÏßÄ ÏÑ†ÌÉùÏúºÎ°ú</a>
                            </div>
                        </div>
                    `;
                    document.querySelector('.game-container').appendChild(endScreen);
                }
        
                window.onload = preloadResources;
            </script>
        </body></html>