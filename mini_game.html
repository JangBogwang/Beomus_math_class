<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>êµ¬êµ¬ë‹¨ ë¯¸ë‹ˆê²Œì„ - ë²”ë®¤ ë ˆì´ìŠ¤</title>
<style>
  :root{
    --radius:16px;
  }
  *{box-sizing:border-box}
  body{
    font-family: system-ui, -apple-system, "Pretendard", Segoe UI, Arial, sans-serif;
    margin:0; background:#f8f9fa; color:#222; text-align:center;
  }
  header{padding:12px 16px}
  h1{font-size:clamp(20px, 4vw, 28px); margin:8px 0 0}

  /* Canvas ë˜í¼: ë°˜ì‘í˜• */
  .stage{
    width: min(96vw, 760px);
    margin: 10px auto 0;
  }
  canvas{
    width:100%;                    /* CSS í¬ê¸°: ë°˜ì‘í˜• */
    height:auto;
    display:block;
    background: linear-gradient(#bde0fe, #fff);
    border:2px solid #333; border-radius:var(--radius);
    touch-action: manipulation;     /* í„°ì¹˜ ì—°íƒ€ ì§€ì—° ë°©ì§€ */
  }

  /* íŒ¨ë„ */
  .panel{
    width:min(96vw, 760px);
    margin: 10px auto 24px;
    display:grid;
    grid-template-columns: 1fr auto auto;
    gap:8px;
    align-items:center;
  }
  #q{margin:0; text-align:left; font-weight:600}
  input, button{
    padding:14px 12px; font-size:16px; border-radius:12px; border:1px solid #aaa;
  }
  input{
    width:100%;
  }
  button{
    background:#4e8ef7; color:#fff; border:none; cursor:pointer;
  }
  .row2{
    width:min(96vw, 760px);
    margin: 0 auto;
    display:flex; gap:8px; justify-content:flex-end;
    padding: 0 0 12px 0;
  }
  .ghost{background:#e9ecef; color:#222; border:1px solid #ccc}

  /* ëª¨ë‹¬ */
  .modal-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.45);
    display:none; align-items:center; justify-content:center; z-index:10;
    padding: 16px;
  }
  .modal{
    background:#fff; border-radius:20px; width:min(96vw, 720px);
    max-height:90vh; overflow:auto; padding:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
    text-align:left;
  }
  .modal h2{margin:6px 6px 10px; font-size:20px}
  .grid{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
    gap:12px; padding: 6px;
  }
  .card{
    border:1px solid #ddd; border-radius:14px; padding:10px; text-align:center;
    cursor:pointer; user-select:none; background:#fafafa
  }
  .card:hover{outline:3px solid #4e8ef7}
  .card img{
    width:80px; height:120px; object-fit:contain; display:block; margin:4px auto 8px;
  }
  .card .nm{font-size:14px; color:#000}
  .modal-actions{
    display:flex; justify-content:flex-end; gap:8px; margin-top:12px;
  }

  /* ëª¨ë°”ì¼ í‚¤ë³´ë“œê°€ ì˜¬ë¼ì™€ë„ ë²„íŠ¼ ëˆ„ë¥´ê¸° ì¢‹ê²Œ */
  @media (max-width: 480px){
    .panel{grid-template-columns: 1fr auto; grid-auto-rows:auto}
    #q{grid-column:1/-1}
    button, input{padding:14px}
  }
</style>
</head>
<body>
  <header>
    <h1>ğŸ» ë²”ë®¤ì˜ êµ¬êµ¬ë‹¨ ë ˆì´ìŠ¤</h1>
  </header>

  <div class="stage">
    <canvas id="game" width="720" height="400" aria-label="ê²Œì„ í™”ë©´"></canvas>
  </div>

  <div class="panel" role="group" aria-label="ë¬¸ì œ íŒ¨ë„">
    <p id="q">ë¬¸ì œ: -</p>
    <input id="ans" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="ì •ë‹µ" autocomplete="off" />
    <button id="ok" aria-label="ì •ë‹µ í™•ì¸">í™•ì¸</button>
  </div>

  <div class="row2">
    <button id="choose" class="ghost" aria-haspopup="dialog">ìºë¦­í„° ì„ íƒ</button>
    <button id="next" class="ghost">ë‹¤ìŒ ë¬¸ì œ</button>
  </div>

  <!-- ëª¨ë‹¬: ìºë¦­í„° ì„ íƒ -->
  <div id="backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="dlgTitle">
    <div class="modal">
      <h2 id="dlgTitle">ìºë¦­í„° ì„ íƒ</h2>
      <div id="grid" class="grid" role="listbox" aria-label="ìºë¦­í„° ëª©ë¡"></div>
      <div class="modal-actions">
        <button id="closeDlg" class="ghost">ë‹«ê¸°</button>
        <button id="applyDlg">ì„ íƒ ì™„ë£Œ</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   1) ìºë¦­í„° ë°ì´í„°
========================= */
const characterData = [
  { src: "asset/img/angry.png", name: "í™”ë‚œ ë²”ë®¤" },
  { src: "asset/img/cowboy.png", name: "ì¹´ìš°ë³´ì´ ë²”ë®¤" },
  { src: "asset/img/cyborg.png", name: "ì‚¬ì´ë³´ê·¸ ë²”ë®¤" },
  { src: "asset/img/hanbok.png", name: "í•œë³µ ë²”ë®¤" },
  { src: "asset/img/idol.png", name: "ì•„ì´ëŒ ë²”ë®¤" },
  { src: "asset/img/knight.png", name: "ê¸°ì‚¬ ë²”ë®¤" },
  { src: "asset/img/normal.png", name: "í‰ë²”í•œ ë²”ë®¤" },
  { src: "asset/img/prince.png", name: "ì™•ì ë²”ë®¤" },
  { src: "asset/img/princess.png", name: "ê³µì£¼ ë²”ë®¤" },
  { src: "asset/img/student.png", name: "í•™ìƒ ë²”ë®¤" },
  { src: "asset/img/summer.png", name: "ì—¬ë¦„ ë²”ë®¤" }
];

/* =========================
   2) ìº”ë²„ìŠ¤/ë°˜ì‘í˜•
========================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resizeCanvas(){
  // ë‚´ë¶€ í•´ìƒë„: ê°€ë…ì„±ì„ ìœ„í•´ ê³ ì • ìœ ì§€(720x400),
  // CSSë¡œë§Œ í­ì„ ë§ì¶° ìŠ¤ì¼€ì¼ (ì´ë¯¸ width:100% ì ìš©)
  // í•„ìš”í•˜ë©´ ê³ í•´ìƒë„ë¥¼ ìœ„í•´ DPR ë°˜ì˜:
  const dpr = Math.min(window.devicePixelRatio || 1, 2);
  const baseW = 720, baseH = 400;
  canvas.width = baseW * dpr;
  canvas.height = baseH * dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);   // ì¢Œí‘œê³„ë¥¼ 1xë¡œ ë§ì¶¤
}
resizeCanvas();
addEventListener("resize", resizeCanvas);

/* =========================
   3) ê²Œì„ ìƒíƒœ
========================= */
let currentCharacter = characterData[0];        // ê¸°ë³¸ ìºë¦­í„°
let playerImg = new Image();
let imgReady = false;

let x = 20;
let yGround = 320;  // ë°”ë‹¥ ê¸°ì¤€ Y (ê·¸ë¦¼ ìœ„ì¹˜ ë³´ì •)
let a=0, b=0, score=0;

const qEl = document.getElementById("q");
const ans = document.getElementById("ans");
const ok = document.getElementById("ok");
const nextBtn = document.getElementById("next");
const chooseBtn = document.getElementById("choose");

/* =========================
   4) ë¬¸ì œ/ë¡œì§
========================= */
function makeQuestion(){
  a = Math.floor(Math.random()*8)+2; // 2~9
  b = Math.floor(Math.random()*8)+2;
  qEl.textContent = `ë¬¸ì œ: ${a} Ã— ${b} = ?`;
  ans.value = "";
  ans.focus({ preventScroll:true });
}

function moveCharacter(){
  // ë‹¨ë§ ë„ˆë¹„ê°€ ì¢ì„ìˆ˜ë¡ ì´ë™í­ë„ ì‚´ì§ ì¤„ì„
  const stageCssWidth = document.querySelector('.stage').clientWidth;
  const step = stageCssWidth < 420 ? 22 : 30;
  x += step;
  if (x > 720 - 100){   // ë‚´ë¶€ ë…¼ë¦¬ í•´ìƒë„ ê¸°ì¤€
    x = 20;
    score++;
  }
}

function submit(){
  const text = ans.value.replace(/[^\d]/g,"");
  const val = Number(text);
  if (!Number.isFinite(val)) return;
  if (val === a*b){
    moveCharacter();
    makeQuestion();
  }else{
    // ëª¨ë°”ì¼ì—ì„œ alertëŠ” ì…ë ¥í¬ì»¤ìŠ¤ ë¬¸ì œë¥¼ ì¼ìœ¼í‚´ -> ë¶€ë“œëŸ½ê²Œ ì•ˆë‚´
    qEl.textContent = `âŒ ì˜¤ë‹µ! ë‹¤ì‹œ ì‹œë„í•´ìš”: ${a} Ã— ${b} = ?`;
    ans.select();
  }
}

/* =========================
   5) ë Œë”ë§
========================= */
function draw(){
  ctx.clearRect(0,0,720,400);

  // ë°”ë‹¥
  ctx.fillStyle = "#6bc9ff";
  ctx.fillRect(0, 360, 720, 40);

  // ì ìˆ˜
  ctx.font = "18px system-ui, Arial";
  ctx.fillStyle = "#333";
  ctx.fillText(`ì ìˆ˜: ${score}`, 16, 28);

  // ìºë¦­í„°
  if (imgReady){
    ctx.drawImage(playerImg, x, yGround-120, 80, 120);
  }else{
    ctx.fillText("ìºë¦­í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...", 300, 200);
  }

  requestAnimationFrame(draw);
}

/* =========================
   6) ìºë¦­í„° ë¡œë”©/ì„ íƒ ëª¨ë‹¬
========================= */
function loadCharacter(char){
  return new Promise((res, rej)=>{
    const img = new Image();
    img.onload = ()=>res(img);
    img.onerror = ()=>rej(new Error("ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: "+char.src));
    img.src = char.src;
  });
}
async function applyCharacter(char){
  try{
    const img = await loadCharacter(char);
    playerImg = img;
    imgReady = true;
    currentCharacter = char;
  }catch(e){
    imgReady = false;
    console.error(e);
    alert("ìºë¦­í„° ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\nê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”:\n" + char.src);
  }
}

/* ëª¨ë‹¬ DOM */
const backdrop = document.getElementById("backdrop");
const grid = document.getElementById("grid");
const closeDlg = document.getElementById("closeDlg");
const applyDlg = document.getElementById("applyDlg");
let pendingChoice = currentCharacter;

function openModal(){
  // ëª©ë¡ ëœë”ë§(ìµœì´ˆ/ì¬ì‚¬ìš©)
  grid.innerHTML = "";
  characterData.forEach((c, idx)=>{
    const card = document.createElement("button");
    card.type = "button";
    card.className = "card";
    card.setAttribute("role", "option");
    card.setAttribute("aria-selected", c.src===pendingChoice.src ? "true":"false");
    card.innerHTML = `
      <img src="${c.src}" alt="${c.name}" onerror="this.style.opacity=.2" />
      <div class="nm">${c.name}</div>
    `;
    card.addEventListener("click", ()=>{
      pendingChoice = c;
      // ì„ íƒ í‘œì‹œ ì—…ë°ì´íŠ¸
      [...grid.children].forEach(el=>el.setAttribute("aria-selected","false"));
      card.setAttribute("aria-selected","true");
      card.style.outline = "3px solid #4e8ef7";
    });
    grid.appendChild(card);
    if(idx===0) card.focus();
  });
  backdrop.style.display = "flex";
}
function closeModal(){
  backdrop.style.display = "none";
  pendingChoice = currentCharacter; // ì·¨ì†Œ ì‹œ ë¡¤ë°±
}
closeDlg.addEventListener("click", closeModal);
applyDlg.addEventListener("click", async ()=>{
  await applyCharacter(pendingChoice);
  currentCharacter = pendingChoice;
  closeModal();
});
chooseBtn.addEventListener("click", openModal);

// ë°”ê¹¥ í´ë¦­ ë‹«ê¸°
backdrop.addEventListener("click", (e)=>{
  if(e.target === backdrop) closeModal();
});

/* =========================
   7) ì´ë²¤íŠ¸/ì´ˆê¸°í™”
========================= */
ok.addEventListener("click", submit);
ans.addEventListener("keydown", e=>{ if(e.key==="Enter") submit(); });
nextBtn.addEventListener("click", makeQuestion);

// ëª¨ë°”ì¼ ë”ë¸”íƒ­ ì¤Œ ë°©ì§€(ë²„íŠ¼ ì—°íƒ€)
let lastTouch=0;
document.addEventListener("touchend", e=>{
  const now=Date.now();
  if(now-lastTouch<300){ e.preventDefault(); }
  lastTouch=now;
},{passive:false});

// ì‹œì‘
draw();
applyCharacter(currentCharacter).then(makeQuestion);
// ì²« ì§„ì… ì‹œ ì„ íƒ íŒì—… ìë™ ì˜¤í”ˆ(ì›ì¹˜ ì•Šìœ¼ë©´ ì£¼ì„ ì²˜ë¦¬)
setTimeout(openModal, 200);
</script>
</body>
</html>
